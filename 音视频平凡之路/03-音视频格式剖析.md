# 第三章 音视频格式剖析
## 1.概要
作为一名音视频工程师，常见的音视频知识是必须要知道的，封装格式、编码格式、视频的YUV排列、H264帧中的SPS与PPS，还有一些传输协议，这些都是流媒体开发中比较常见的技术方案，作为一个合格的音视频工程师，不需要你样样精通，但是你一定要心中有数，知道原理。<br>
不掌握核心原理去优化，是没法达到好的效果的，所以我们学习东西还是要深入到内部，了解原理细节。本文主要阐释音视频开发中经常会用到的一些格式和格式中的重要概念。
## 2.常见音视频封装格式
封装格式就是视频最外层的一套衣服，视频的内部数据都在这个封装格式内部，视频有音频轨道信息、视频轨道信息，甚至还有字幕轨道信息，这个信息或者数据流都被集成在封装格式中，所以解剖这些小麻雀是我们音视频进阶的第一步，开始脱衣服了，兄弟们。
### 2.1 MP4
MP4应用有广泛，现在最火的短视频都是采用MP4的封装格式，还是首先抛出一个问题，MP4的全程是什么？<br>
我去，全程是什么有那么重要吗？我之前在学校的时候被导师说过一次，他当时问我FFmpeg的全程是什么？我一脸懵逼，当时他就说我研究一个东西难道不应该先搞清楚这个东西来龙去脉吗？当时觉得委屈，现在想想看看，还是有一定的道理，稍微花点时间，可以搞清楚的事情有时候却不愿意去搞明白，还是学习地不彻底。好了，言归正传。<br>
MP4就是MPEG-4，MPEG的全程是Moving Picture Experts Group，即动态影像专家组，MPEG第一代在1998年就提出来了，目前最新的版本是MPEG-4，MPEG-4相对其前辈而言有高度的压缩比和高清的画质以及较高的灵活性。大家感兴趣可以看看MPEG的发展历史：https://zh.wikipedia.org/wiki/MPEG-4 <br>

下面我们通过分析MP4的结构来解剖这只小麻雀。<br>
MP4本质是一个BOX的嵌套结构，就是像套娃一样，主要包含四个一级文件索引:<br>
![MP4一级文件索引](./03-files/01.png)<br>
**ftyp :**<br> 
File Type Box，该Box有且只有一个，通常放在文件开始的位置，指示该MP4文件的相关信息，依次包括32位的major brand(4个字符)，1个32位的minor version和1个32位的compatible brands，见下图。<br>
[ftyp信息图](./03-files/02.png)<br>
```
public class FileTypeBox extends AbstractBox {
    public static final String TYPE = "ftyp";

    private String majorBrand;
    private long minorVersion;
    private List<String> compatibleBrands = Collections.emptyList();

    public FileTypeBox() {
        super(TYPE);
    }

    public FileTypeBox(String majorBrand, long minorVersion, List<String> compatibleBrands) {
        super(TYPE);
        this.majorBrand = majorBrand;
        this.minorVersion = minorVersion;
        this.compatibleBrands = compatibleBrands;
    }
    //......

}

```
major_brand就是mp42，minor_version是0，compatible_brands是isom,mp42
**free :**<br>
free box里面的数据无关紧要，基本上是可有可无的，它被删除了不会对播放产生任何影响，主要是最初的版本就有free box，后面为了向前兼容，所以没有删除。
```
public class FreeSpaceBox extends AbstractBox {
    public static final String TYPE = "skip";

    byte[] data;

    public FreeSpaceBox() {
        super(TYPE);
    }

    protected long getContentSize() {
        return data.length;
    }

    public byte[] getData() {
        return data;
    }

    public void setData(byte[] data) {
        this.data = data;
    }
    //......
}

```
它的type通常是FREE或者是SKIP的。大家了解即可。

**mdat :**<br>
mdat存储是具体的音视频数据，当然是解码之前的数据，由于MP4知识封装格式，所以这部分原始数据我们不需要过多深究其细节，只要知道多大就行了，指引解析mdat的地方才是比较重要的地方，就是下面我们要讲的moov box结构。

**moov :**<br>
moov是MP4文件中非常重要的一个BOX，其中存放媒体的metadata信息，MP4文件的所有属性信息都会在moov中显示，下面是moov的结构示意图：<br>
![moov结构示意图](./03-files/03.png)<br>
![trak结构示意图](./03-files/04.png)<br>
如上图所示，moov的完整结构非常复杂。其一级目录中主要包括mvhd、meta、trak、udta<br>

mvhd又称为 movie header atom info，存放视频的基本信息，例如时长、码率、音量等等。<br>
![mvhd基本信息](./03-files/05.png)<br>
> * version : box版本号
> * creation_time : 创建时间，相对UTC-1904-01-01的时间
> * modification_time : 最后的修改时间
> * time_scale : 1s时间的刻度值
> * duration : 时间长度， 和time_scale一起可以计算总时长，  duraion / time_scale，例如上面的视频就是12s多一点。
> * rate : 推荐的播放速率
> * volume : 推荐的音量大小
> * matrix : 指定的视频变换矩阵
> * next_track_id : 指定下一个轨道的索引，这儿是3，说明已经有2个轨道了。

```
public class MovieBox extends AbstractContainerBox {
    public static final String TYPE = "moov";

    public MovieBox() {
        super(TYPE);
    }

    public int getTrackCount() {
        return getBoxes(TrackBox.class).size();
    }


    /**
     * Returns the track numbers associated with this <code>MovieBox</code>.
     *
     * @return the tracknumbers (IDs) of the tracks in their order of appearance in the file
     */
    public long[] getTrackNumbers() {

        List<TrackBox> trackBoxes = this.getBoxes(TrackBox.class);
        long[] trackNumbers = new long[trackBoxes.size()];
        for (int trackCounter = 0; trackCounter < trackBoxes.size(); trackCounter++) {
            trackNumbers[trackCounter] = trackBoxes.get(trackCounter).getTrackHeaderBox().getTrackId();
        }
        return trackNumbers;
    }

    public MovieHeaderBox getMovieHeaderBox() {
        return Path.getPath(this, "mvhd");
    }

}

```

这已经是可视化的分析数据了，其实分析文件结构就是读位运算，还挺枯燥的。<br><br>

trak一听就是存储轨道信息，像上面的示意图，有两个轨道信息，我们拿出其中一个来分析一下。一个视频中多个track信息是互相独立的，分别有自己的时间和空间信息，trak信息包含一个tkhd和mdia box结构，下面是trak的代码逻辑：
```
public class TrackBox extends AbstractContainerBox {
    public static final String TYPE = "trak";
    private SampleTableBox sampleTableBox;

    public TrackBox() {
        super(TYPE);
    }

    public TrackHeaderBox getTrackHeaderBox() {
        return Path.getPath(this, "tkhd[0]");
    }

    /**
     * Gets the SampleTableBox at mdia/minf/stbl if existing.
     *
     * @return the SampleTableBox or <code>null</code>
     */
    public SampleTableBox getSampleTableBox() {
        if (sampleTableBox != null) {
            return sampleTableBox;
        }
        MediaBox mdia = getMediaBox();
        if (mdia != null) {
            MediaInformationBox minf = mdia.getMediaInformationBox();
            if (minf != null) {
                sampleTableBox = minf.getSampleTableBox();
                return sampleTableBox;
            }
        }
        return null;

    }


    public MediaBox getMediaBox() {
        return Path.getPath(this, "mdia[0]");
    }

    @Override
    public void setBoxes(List<? extends Box> boxes) {
        super.setBoxes(boxes);
        sampleTableBox = null;
    }

}

```
其中tkhd是trak的属性信息的集合，相当月trak的头文件：<br>
![tkhd信息](./06-files/06.png)<br>
> * version : 版本号，通常为0或者1 
> * track_id : 轨道索引号
> * layer : 指定的视频层次，默认为0，越小越在上面
> * width : 视频的宽
> * height : 视频的高，音频一般没有这个信息的。

![音频的trak信息](./03-files/07.png)<br><br>

mdia 则是整个track的媒体相关的信息，其中mdhd是其头部信息，mdhd和tkhd内容大致一样。如下图，不做过多的介绍了。<br>
![mdhd信息](./03-files/08.png)<br>

stbl 存储音视频的chunk数据，像一个链表一样，存储着一个个sample块结构，<br>
stts中有块个数，stsz有sample size， 可以通过sample size到mdat中读取对应的数据。<br>

简单分析了MP4的结构，我们会有一个疑问，moov是MP4的是头文件，那为什么moov在文件末尾了？会不会有问题，我要播放MP4文件，肯定要先读moov数据，才能通过moov信息到mdat找对应的原始数据。<br>
其实标准的MP4文件中moov应该在mdat之前的，上面的视频一般是手机录制的视频，我们在短视频应用中需要在后台将moov处理放到mdat之前，因为边下边播的必要条件就是要moov一定要在mdat之前，不然双IO请求处理非常复杂。<br>
这也间接说明了MP4文件并不是流式文件，它的诞生有很强的时代背景，在如今流式文件满天飞的时代，MP4是不能作为直播的封装格式存在的。<br>

下面是指令可以将MP4文件的moov放到mdat之前。
```
ffmpeg -i input.mp4 -movflags faststart output.mp4

```
<br>
虽然MPEG-4文件的标准后缀名是.mp4，但是还有一些其他的后缀名，例如仅有音频的文件会使用.m4a作为后缀名，苹果中的音频加密文件会使用.m4p作为后缀名，早期的移动电话会使用.3qp作为后缀名。<br>

上面分析MP4 box结构的工具是在线的工具，现在附上具体的链接：https://gpac.github.io/mp4box.js/test/filereader.html
### 2.2 FLV
上面提到了MP4不能作为直播的流式文件，因为MP4的BOX结构的限制，那可以作为直播的格式是什么？FLV开始登上历史的舞台。<br>

### 2.3 HLS
### 2.4 DASH
## 3.常见的音视频编码格式
### 3.1 H264
### 3.2 HEVC
### 3.3 AAC
## 4.一些重要的概念
### 4.1 YUV
### 4.2 SPS与PPS
## 3.常见的音视频传输协议
### 3.1 RTMP
### 3.2 QUIC
